<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linear Programming Optimizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">    <title>Linear Programming Optimizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="section-title">Linear Programming Optimizer</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}        <!-- Variable Input Modal -->
        <div id="addVariableModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Add Product</h2>
                    <span class="close">&times;</span>
                </div>
                <form method="POST" class="form-group">
                    <div class="modal-body">
                        <div>
                            <label for="name">Product Name:</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div>
                            <label for="lowerBound">Min Stock:</label>
                            <input type="number" class="form-control" id="lowerBound" name="lowerBound" value="0">
                        </div>
                        <div>
                            <label for="upperBound">Max Stock:</label>
                            <input type="number" class="form-control" id="upperBound" name="upperBound">
                        </div>
                        <div>
                            <label for="multiplier">Unit Cost:</label>
                            <input type="number" class="form-control" id="multiplier" name="multiplier" value="1" step="0.01" required>
                        </div>
                        <div>
                            <label>Input Mode:</label>
                            <select id="input_mode" class="form-control">
                                <option value="selling_price">Enter Unit Selling Price</option>
                                <option value="profit_per_dollar">Enter Profit per Dollar</option>
                            </select>
                        </div>
                        <div id="unit_selling_price_group">
                            <label for="unit_selling_price">Unit Selling Price:</label>
                            <input type="number" class="form-control" id="unit_selling_price" name="unit_selling_price" value="" step="0.01">
                        </div>
                        <div id="profit_per_dollar_group" style="display:none;">
                            <label for="profit_per_dollar">Profit per Rand:</label>
                            <input type="number" class="form-control" id="profit_per_dollar" name="profit_per_dollar" value="" step="0.0001">
                        </div>
                        <div class="checkbox-group">
                            <label for="integer">Whole Units Only?</label>
                            <input type="checkbox" id="integer" name="integer" checked>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" name="add_variable" class="btn btn-primary">Add Product</button>
                    </div>
                </form>
            </div>
        </div><!-- Current Products Section -->
        <section class="section card">
            <div class="section-header">
                <h2 class="card-title">Current Products</h2>
                <div class="file-controls">
                    <input type="text" class="form-control filename-input" id="filename" value="products.json" required
                           oninput="updateFileName(this.value)" aria-label="File name for export or download">
                    <div class="button-group">
                        <form method="post" action="/export" class="inline-form">
                            <input type="hidden" id="export-filename" name="filename" value="products.json">
                            <button type="submit" class="btn btn-primary btn-sm">Export</button>
                        </form>
                        <form method="POST" action="/download" class="inline-form">
                            <input type="hidden" id="download-filename" name="filename" value="products.json">
                            <button type="submit" class="btn btn-primary btn-sm">Download</button>
                        </form>
                        <form method="post" action="/import" enctype="multipart/form-data" class="inline-form import-form">
                            <label for="file" class="btn btn-primary btn-sm upload-btn">
                                Upload JSON
                                <input type="file" class="hidden-file-input" id="file" name="file" accept=".json" onchange="this.form.submit()">
                            </label>
                        </form>
                    </div>
                </div>
            </div>
            {% if variables %}
            <div class="table-responsive">
                <table class="table">                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Min Stock</th>
                            <th>Max Stock</th>
                            <th>Unit Cost</th>
                            <th>Unit Selling Price</th>
                            <th>Raw Profit</th>
                            <th>Profit per Rand</th>
                            <th>Whole Units Only?</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for var in variables %}
                        <tr>
                            <td>{{ var.name }}</td>
                            <td>{{ "{:.2f}".format(var.lowerBound) }}</td>
                            <td>{% if var.upperBound != None %}{{ "{:.2f}".format(var.upperBound) }}{% else %}∞{% endif %}</td>
                            <td>{{ "{:.2f}".format(var.multiplier) }}</td>
                            <td>{% if var.unit_selling_price is defined %}{{ "{:.2f}".format(var.unit_selling_price) }}{% endif %}</td>
                            <td>
                                {% set cost = var.unit_cost if var.unit_cost is defined else var.multiplier %}
                                {% if var.unit_selling_price is defined and cost is not none %}
                                    {{ "{:.2f}".format(var.unit_selling_price - cost) }}
                                {% elif var.profit is defined and cost is not none %}
                                    {{ "{:.2f}".format(var.profit * cost) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ "{:.4f}".format(var.profit) }}</td>
                            <td>{{ "Yes" if var.integer else "No" }}</td>
                            <td class="table-actions-cell">
                                <div class="button-group">
                                    <button type="button" class="btn btn-primary btn-sm"
                                            onclick='editVariable({{ var | tojson | safe }})'>
                                        Edit
                                    </button>
                                    <form method="POST" action="{{ url_for('delete_variable', name=var.name) }}" 
                                          class="inline-form" 
                                          onsubmit="return confirm('Are you sure you want to delete this product?');">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>            {% else %}
            <p>No products added yet.</p>
            {% endif %}
            <div class="table-actions">
                <button type="button" class="btn btn-primary" onclick="openModal()">Add Product</button>
                <form id="clear-table-form" class="inline-form" style="display:inline;">
                    <button type="button" class="btn btn-danger" id="clear-table-btn">Clear Table</button>
                </form>
            </div>
        </section>

        <!-- Constraints Section -->
        <section class="section card">
            <h2 class="card-title">Constraints</h2>
            <form method="POST" class="form-group">
                <label for="budget">Budget Constraint:</label>
                <div class="input-group">
                    <span class="input-group-text">£</span>
                    <input type="number" class="form-control" name="budget" id="budget" value="{{ budget }}" min="0" required>
                </div>
                <button type="submit" name="update_budget" class="btn btn-primary">Update Budget</button>
            </form>
        </section>
        
        <!-- Optimization Section -->
        <section class="section card">
            <h2 class="card-title">Optimization</h2>
            <form method="POST">
                <button type="submit" name="optimize" class="btn btn-success">Run Optimization</button>
            </form>

            {% if max_profit %}
            <div class="results">
                <h3>Results</h3>
                <div class="card-deck" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card result-card" style="flex: 1; background: #f8f9fa; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
                        <h5>Maximum Revenue</h5>
                        <p class="card-value" style="font-size: 1.3em; font-weight: bold; color: #2c7;">R{{ "%.2f"|format(total_revenue) }}</p>
                    </div>
                    <div class="card result-card" style="flex: 1; background: #f8f9fa; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
                        <h5>Maximum Profit</h5>
                        <p class="card-value" style="font-size: 1.3em; font-weight: bold; color: #27c;">R{{ "%.2f"|format(max_profit_value) }}</p>
                    </div>
                    <div class="card result-card" style="flex: 1; background: #f8f9fa; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
                        <h5>Total Unit Cost</h5>
                        <p class="card-value" style="font-size: 1.3em; font-weight: bold; color: #c72;">R{{ "%.2f"|format(total_unit_cost) }}</p>
                    </div>
                </div>
                <h4>Optimal Product Breakdown</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Units Acquired</th>
                                <th>Cost per Unit (R)</th>
                                <th>Total Spent (R)</th>
                                <th>Profit per Unit (R)</th>
                                <th>Total Profit (R)</th>
                                <th>Revenue (R)</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for name, value in result.items() %}
                            {% set var = (variables | selectattr('name', 'equalto', name) | list)[0] %}
                            {% set units = product_units[name] %}
                            {% set cost_per_unit = var.unit_cost if var.unit_cost is defined else var.multiplier %}
                            {% set profit_per_unit = var.profit * cost_per_unit %}
                            {% set total_profit = profit_per_unit * units %}
                            {% set revenue = units * (var.unit_selling_price if var.unit_selling_price is defined else 0) %}
                            <tr>
                                <td>{{ name }}</td>
                                <td>{{ units }}</td>
                                <td>R{{ "{:.2f}".format(cost_per_unit) }}</td>
                                <td>R{{ "{:.2f}".format(value) }}</td>
                                <td>R{{ "{:.2f}".format(profit_per_unit) }}</td>
                                <td>R{{ "{:.2f}".format(total_profit) }}</td>
                                <td>R{{ "{:.2f}".format(revenue) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}        </section>
    </div>    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // File name updating
            function updateFileName(value) {
                document.getElementById('export-filename').value = value;
                document.getElementById('download-filename').value = value;
            }
            
            // Make updateFileName available globally
            window.updateFileName = updateFileName;

            // Modal functionality
            const modal = document.getElementById('addVariableModal');
            const modalTitle = document.querySelector('.modal-title');
            const form = modal.querySelector('form');
            const closeBtn = document.querySelector('.close');
            const submitBtn = form.querySelector('button[name="add_variable"]');
            let isEditing = false;
            let editingName = '';
            
            window.openModal = function() {
                if (modal) {
                    isEditing = false;
                    modalTitle.textContent = 'Add Product';
                    submitBtn.textContent = 'Add Product';
                    form.reset();
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            window.editVariable = function(variable) {
                if (modal) {
                    isEditing = true;
                    editingName = variable.name;
                    modalTitle.textContent = 'Edit Product';
                    submitBtn.textContent = 'Update Product';

                    // Fill form with variable data
                    form.name.value = variable.name;
                    form.lowerBound.value = variable.lowerBound;
                    form.upperBound.value = variable.upperBound;
                    form.multiplier.value = variable.unit_cost !== undefined ? variable.unit_cost : variable.multiplier;
                    // Prefer to show selling price if available, else profit per dollar
                    if (variable.unit_selling_price !== undefined && variable.unit_selling_price !== 0) {
                        document.getElementById('input_mode').value = 'selling_price';
                        document.getElementById('unit_selling_price').value = variable.unit_selling_price;
                        document.getElementById('profit_per_dollar').value = variable.profit !== undefined ? variable.profit : '';
                    } else {
                        document.getElementById('input_mode').value = 'profit_per_dollar';
                        document.getElementById('profit_per_dollar').value = variable.profit !== undefined ? variable.profit : '';
                        document.getElementById('unit_selling_price').value = '';
                    }
                    form.integer.checked = variable.integer;
                    // Show/hide fields
                    document.getElementById('input_mode').dispatchEvent(new Event('change'));
                    updateProfitAndSellingPrice();
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            window.closeModal = function() {
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    isEditing = false;
                    form.reset();
                }
            }
            
            // Handle form submission
            form.addEventListener('submit', function(e) {
                if (isEditing) {
                    e.preventDefault();
                    const formData = new FormData(form);
                    formData.append('old_name', editingName);
                    
                    fetch('/update_variable', {
                        method: 'POST',
                        body: formData
                    }).then(async response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            const data = await response.json();
                            throw new Error(data.message || 'Failed to update variable');
                        }
                    }).catch(error => {
                        showError('Error updating variable: ' + error.message);
                    });
                }
            });
            
            // Function to display error messages
            function showError(message) {
                alert(message);
            }
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            }
            
            // Close modal when clicking the X
            if (closeBtn) {
                closeBtn.onclick = closeModal;
            }
            
            // Close modal when pressing Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        });
        
        // Live calculation for Profit per Dollar and Selling Price
        function updateProfitAndSellingPrice() {
            const cost = parseFloat(document.getElementById('multiplier').value) || 0;
            const inputMode = document.getElementById('input_mode').value;
            if (inputMode === 'selling_price') {
                const price = parseFloat(document.getElementById('unit_selling_price').value) || 0;
                let profitPerDollar = '';
                if (cost > 0) {
                    profitPerDollar = ((price - cost) / cost).toFixed(4);
                }
                document.getElementById('profit_per_dollar').value = profitPerDollar;
            } else {
                const profitPerDollar = parseFloat(document.getElementById('profit_per_dollar').value) || 0;
                let price = '';
                if (cost > 0) {
                    price = (cost * (1 + profitPerDollar)).toFixed(2);
                }
                document.getElementById('unit_selling_price').value = price;
            }
        }
        document.getElementById('multiplier').addEventListener('input', updateProfitAndSellingPrice);
        document.getElementById('unit_selling_price').addEventListener('input', updateProfitAndSellingPrice);
        document.getElementById('profit_per_dollar').addEventListener('input', updateProfitAndSellingPrice);
        document.getElementById('input_mode').addEventListener('change', function() {
            if (this.value === 'selling_price') {
                document.getElementById('unit_selling_price_group').style.display = '';
                document.getElementById('profit_per_dollar_group').style.display = 'none';
            } else {
                document.getElementById('unit_selling_price_group').style.display = 'none';
                document.getElementById('profit_per_dollar_group').style.display = '';
            }
            updateProfitAndSellingPrice();
        });
        // On edit, set input mode and fill both fields if possible
        window.editVariable = function(variable) {
            if (modal) {
                isEditing = true;
                editingName = variable.name;
                modalTitle.textContent = 'Edit Product';
                submitBtn.textContent = 'Update Product';
                form.name.value = variable.name;
                form.lowerBound.value = variable.lowerBound;
                form.upperBound.value = variable.upperBound;
                form.multiplier.value = variable.unit_cost !== undefined ? variable.unit_cost : variable.multiplier;
                // Prefer to show selling price if available, else profit per dollar
                if (variable.unit_selling_price !== undefined && variable.unit_selling_price !== 0) {
                    document.getElementById('input_mode').value = 'selling_price';
                    document.getElementById('unit_selling_price').value = variable.unit_selling_price;
                    document.getElementById('profit_per_dollar').value = variable.profit !== undefined ? variable.profit : '';
                } else {
                    document.getElementById('input_mode').value = 'profit_per_dollar';
                    document.getElementById('profit_per_dollar').value = variable.profit !== undefined ? variable.profit : '';
                    document.getElementById('unit_selling_price').value = '';
                }
                form.integer.checked = variable.integer;
                // Show/hide fields
                document.getElementById('input_mode').dispatchEvent(new Event('change'));
                updateProfitAndSellingPrice();
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }
        // On add, default to selling price mode
        document.getElementById('input_mode').value = 'selling_price';
        document.getElementById('input_mode').dispatchEvent(new Event('change'));

        document.getElementById('clear-table-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all products?')) {
                fetch('/clear_table', {method: 'POST'})
                    .then(() => window.location.reload());
            }
        });
    </script>
</body>
</html>
